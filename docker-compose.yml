version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: news-trend-redis
    # 내부 네트워크에서만 접근 가능하도록 포트 제거 권장
    # 외부 접근이 필요한 경우에만 포트 매핑
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - news-trend-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  collector:
    build:
      context: .
      dockerfile: Dockerfile.collector
    container_name: news-trend-collector
    ports:
      - "${COLLECTOR_PORT:-3001}:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      - COLLECTOR_PORT=3001
      - ELASTICSEARCH_NODE=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
      - ELASTICSEARCH_INDEX_ARTICLES=${ELASTICSEARCH_INDEX_ARTICLES:-news-articles}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      - ALLOWED_ADMIN_IPS=${ALLOWED_ADMIN_IPS:-}
      - THROTTLE_TTL=${THROTTLE_TTL:-60}
      - THROTTLE_LIMIT=${THROTTLE_LIMIT:-100}
    volumes:
      - ./data:/app/data
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - news-trend-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  trend:
    build:
      context: .
      dockerfile: Dockerfile.trend
    container_name: news-trend-trend
    ports:
      - "${TREND_PORT:-3002}:3002"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      - TREND_PORT=3002
      - ELASTICSEARCH_NODE=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
      - ELASTICSEARCH_INDEX_ARTICLES=${ELASTICSEARCH_INDEX_ARTICLES:-news-articles}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - THROTTLE_TTL=${THROTTLE_TTL:-60}
      - THROTTLE_LIMIT=${THROTTLE_LIMIT:-100}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - news-trend-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
    container_name: news-trend-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=${ELASTICSEARCH_SECURITY_ENABLED:-false}
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    # 내부 네트워크에서만 접근 가능하도록 포트 제거 권장
    # 외부 접근이 필요한 경우에만 포트 매핑
    volumes:
      - es-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s --fail http://localhost:9200/_cluster/health?wait_for_status=yellow || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - news-trend-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.2
    container_name: news-trend-kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_PUBLICBASEURL=${KIBANA_PUBLIC_BASE_URL:-}
    # 내부 네트워크에서만 접근 가능하도록 포트 제거 권장
    # 외부 접근이 필요한 경우에만 포트 매핑
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - news-trend-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  redis-data:
  es-data:

networks:
  news-trend-network:
    driver: bridge


